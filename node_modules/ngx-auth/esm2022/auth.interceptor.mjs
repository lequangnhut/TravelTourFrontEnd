import { Inject, Injectable } from '@angular/core';
import { Subject, throwError } from 'rxjs';
import { catchError, first, map, switchMap } from 'rxjs/operators';
import { AUTH_SERVICE } from './tokens';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "./auth.service";
class AuthInterceptor {
    authService;
    http;
    /**
     * Is refresh token is being executed
     */
    refreshInProgress = false;
    /**
     * Notify all outstanding requests through this subject
     */
    refreshSubject = new Subject();
    constructor(authService, http) {
        this.authService = authService;
        this.http = http;
    }
    /**
     * Intercept an outgoing `HttpRequest`
     */
    intercept(req, delegate) {
        if (this.skipRequest(req)) {
            return delegate.handle(req);
        }
        return this.processIntercept(req, delegate);
    }
    /**
     * Process all the requests via custom interceptors.
     */
    processIntercept(original, delegate) {
        const clone = original.clone();
        return this.request(clone)
            .pipe(switchMap((req) => delegate.handle(req)), catchError((res) => this.responseError(clone, res)));
    }
    /**
     * Request interceptor. Delays request if refresh is in progress
     * otherwise adds token to the headers
     */
    request(req) {
        if (this.refreshInProgress) {
            return this.delayRequest(req);
        }
        return this.addToken(req);
    }
    /**
     * Failed request interceptor, check if it has to be processed with refresh
     */
    responseError(req, res) {
        const refreshShouldHappen = this.authService.refreshShouldHappen(res, req);
        if (refreshShouldHappen && !this.refreshInProgress) {
            this.refreshInProgress = true;
            this.authService.refreshToken()
                .subscribe({
                next: () => {
                    this.refreshInProgress = false;
                    this.refreshSubject.next(true);
                },
                error: () => {
                    this.refreshInProgress = false;
                    this.refreshSubject.next(false);
                },
            });
        }
        if (refreshShouldHappen && this.refreshInProgress) {
            return this.retryRequest(req, res);
        }
        return throwError(() => res);
    }
    /**
     * Add access token to headers or the request
     */
    addToken(req) {
        return this.authService.getAccessToken()
            .pipe(first(), map((token) => {
            if (token) {
                return req.clone({
                    setHeaders: this.authService.getHeaders?.(token) ?? { Authorization: `Bearer ${token}` },
                });
            }
            return req;
        }));
    }
    /**
     * Delay request, by subscribing on refresh event, once it finished, process it
     * otherwise throw error
     */
    delayRequest(req) {
        return this.refreshSubject.pipe(first(), switchMap((status) => status ? this.addToken(req) : throwError(() => req)));
    }
    /**
     * Retry request, by subscribing on refresh event, once it finished, process it
     * otherwise throw error
     */
    retryRequest(req, res) {
        return this.refreshSubject.pipe(first(), switchMap((status) => status ? this.http.request(req) : throwError(() => res || req)));
    }
    /**
     * Checks if request must be skipped by interceptor.
     */
    skipRequest(req) {
        return this.authService.skipRequest?.(req) || this.authService.verifyRefreshToken?.(req);
    }
    static ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.0.4", ngImport: i0, type: AuthInterceptor, deps: [{ token: AUTH_SERVICE }, { token: i1.HttpClient }], target: i0.ɵɵFactoryTarget.Injectable });
    static ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "16.0.4", ngImport: i0, type: AuthInterceptor });
}
export { AuthInterceptor };
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.0.4", ngImport: i0, type: AuthInterceptor, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i2.AuthService, decorators: [{
                    type: Inject,
                    args: [AUTH_SERVICE]
                }] }, { type: i1.HttpClient }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC5pbnRlcmNlcHRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hdXRoLmludGVyY2VwdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQVFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ25ELE9BQU8sRUFBYyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3ZELE9BQU8sRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUduRSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sVUFBVSxDQUFDOzs7O0FBRXhDLE1BQ2EsZUFBZTtJQWFNO0lBQ3RCO0lBWlY7O09BRUc7SUFDSyxpQkFBaUIsR0FBRyxLQUFLLENBQUM7SUFFbEM7O09BRUc7SUFDSyxjQUFjLEdBQXFCLElBQUksT0FBTyxFQUFXLENBQUM7SUFFbEUsWUFDZ0MsV0FBd0IsRUFDOUMsSUFBZ0I7UUFETSxnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUM5QyxTQUFJLEdBQUosSUFBSSxDQUFZO0lBQ3RCLENBQUM7SUFFTDs7T0FFRztJQUNILFNBQVMsQ0FDUCxHQUFxQixFQUNyQixRQUFxQjtRQUVyQixJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDekIsT0FBTyxRQUFRLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQzdCO1FBRUQsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQzlDLENBQUM7SUFFRDs7T0FFRztJQUNLLGdCQUFnQixDQUN0QixRQUEwQixFQUMxQixRQUFxQjtRQUVyQixNQUFNLEtBQUssR0FBcUIsUUFBUSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBRWpELE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUM7YUFDdkIs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QUMsQ0FBQyxNQUFlLEVBQUUsRUFBRSxDQUM1QixNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxDQUMvRCxDQUNGLENBQUM7SUFDSixDQUFDO0lBRUQ7O09BRUc7SUFDSyxXQUFXLENBQUMsR0FBcUI7UUFDdkMsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDLFdBQVcsRUFBRSxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsa0JBQWtCLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUMzRixDQUFDO3VHQWpKVSxlQUFlLGtCQWFoQixZQUFZOzJHQWJYLGVBQWU7O1NBQWYsZUFBZTsyRkFBZixlQUFlO2tCQUQzQixVQUFVOzswQkFjTixNQUFNOzJCQUFDLFlBQVkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBIdHRwQ2xpZW50LFxuICBIdHRwRXJyb3JSZXNwb25zZSxcbiAgSHR0cEV2ZW50LFxuICBIdHRwSGFuZGxlcixcbiAgSHR0cEludGVyY2VwdG9yLFxuICBIdHRwUmVxdWVzdCxcbn0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0LCB0aHJvd0Vycm9yIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBjYXRjaEVycm9yLCBmaXJzdCwgbWFwLCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7IEF1dGhTZXJ2aWNlIH0gZnJvbSAnLi9hdXRoLnNlcnZpY2UnO1xuaW1wb3J0IHsgQVVUSF9TRVJWSUNFIH0gZnJvbSAnLi90b2tlbnMnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQXV0aEludGVyY2VwdG9yIGltcGxlbWVudHMgSHR0cEludGVyY2VwdG9yIHtcblxuICAvKipcbiAgICogSXMgcmVmcmVzaCB0b2tlbiBpcyBiZWluZyBleGVjdXRlZFxuICAgKi9cbiAgcHJpdmF0ZSByZWZyZXNoSW5Qcm9ncmVzcyA9IGZhbHNlO1xuXG4gIC8qKlxuICAgKiBOb3RpZnkgYWxsIG91dHN0YW5kaW5nIHJlcXVlc3RzIHRocm91Z2ggdGhpcyBzdWJqZWN0XG4gICAqL1xuICBwcml2YXRlIHJlZnJlc2hTdWJqZWN0OiBTdWJqZWN0PGJvb2xlYW4+ID0gbmV3IFN1YmplY3Q8Ym9vbGVhbj4oKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBASW5qZWN0KEFVVEhfU0VSVklDRSkgcHJpdmF0ZSBhdXRoU2VydmljZTogQXV0aFNlcnZpY2UsXG4gICAgcHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50LFxuICApIHsgfVxuXG4gIC8qKlxuICAgKiBJbnRlcmNlcHQgYW4gb3V0Z29pbmcgYEh0dHBSZXF1ZXN0YFxuICAgKi9cbiAgaW50ZXJjZXB0KFxuICAgIHJlcTogSHR0cFJlcXVlc3Q8YW55PixcbiAgICBkZWxlZ2F0ZTogSHR0cEhhbmRsZXJcbiAgKTogT2JzZXJ2YWJsZTxIdHRwRXZlbnQ8YW55Pj4ge1xuICAgIGlmICh0aGlzLnNraXBSZXF1ZXN0KHJlcSkpIHtcbiAgICAgIHJldHVybiBkZWxlZ2F0ZS5oYW5kbGUocmVxKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5wcm9jZXNzSW50ZXJjZXB0KHJlcSwgZGVsZWdhdGUpO1xuICB9XG5cbiAgLyoqXG4gICAqIFByb2Nlc3MgYWxsIHRoZSByZXF1ZXN0cyB2aWEgY3VzdG9tIGludGVyY2VwdG9ycy5cbiAgICovXG4gIHByaXZhdGUgcHJvY2Vzc0ludGVyY2VwdChcbiAgICBvcmlnaW5hbDogSHR0cFJlcXVlc3Q8YW55PixcbiAgICBkZWxlZ2F0ZTogSHR0cEhhbmRsZXJcbiAgKTogT2JzZXJ2YWJsZTxIdHRwRXZlbnQ8YW55Pj4ge1xuICAgIGNvbnN0IGNsb25lOiBIdHRwUmVxdWVzdDxhbnk+ID0gb3JpZ2luYWwuY2xvbmUoKTtcblxuICAgIHJldHVybiB0aGlzLnJlcXVlc3QoY2xvbmUpXG4gICAgICAucGlwZShcbiAgICAgICAgc3dpdGNoTWFwKChyZXE6IEh0dHBSZXF1ZXN0PGFueT4pID0+IGRlbGVnYXRlLmhhbmRsZShyZXEpKSxcbiAgICAgICAgY2F0Y2hFcnJvcigocmVzOiBIdHRwRXJyb3JSZXNwb25zZSkgPT4gdGhpcy5yZXNwb25zZUVycm9yKGNsb25lLCByZXMpKVxuICAgICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXF1ZXN0IGludGVyY2VwdG9yLiBEZWxheXMgcmVxdWVzdCBpZiByZWZyZXNoIGlzIGluIHByb2dyZXNzXG4gICAqIG90aGVyd2lzZSBhZGRzIHRva2VuIHRvIHRoZSBoZWFkZXJzXG4gICAqL1xuICBwcml2YXRlIHJlcXVlc3QocmVxOiBIdHRwUmVxdWVzdDxhbnk+KTogT2JzZXJ2YWJsZTxIdHRwUmVxdWVzdDxhbnk+PiB7XG4gICAgaWYgKHRoaXMucmVmcmVzaEluUHJvZ3Jlc3MpIHtcbiAgICAgIHJldHVybiB0aGlzLmRlbGF5UmVxdWVzdChyZXEpO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmFkZFRva2VuKHJlcSk7XG4gIH1cblxuICAvKipcbiAgICogRmFpbGVkIHJlcXVlc3QgaW50ZXJjZXB0b3IsIGNoZWNrIGlmIGl0IGhhcyB0byBiZSBwcm9jZXNzZWQgd2l0aCByZWZyZXNoXG4gICAqL1xuICBwcml2YXRlIHJlc3BvbnNlRXJyb3IoXG4gICAgcmVxOiBIdHRwUmVxdWVzdDxhbnk+LFxuICAgIHJlczogSHR0cEVycm9yUmVzcG9uc2VcbiAgKTogT2JzZXJ2YWJsZTxIdHRwRXZlbnQ8YW55Pj4ge1xuICAgIGNvbnN0IHJlZnJlc2hTaG91bGRIYXBwZW46IGJvb2xlYW4gPVxuICAgICAgdGhpcy5hdXRoU2VydmljZS5yZWZyZXNoU2hvdWxkSGFwcGVuKHJlcywgcmVxKTtcblxuICAgIGlmIChyZWZyZXNoU2hvdWxkSGFwcGVuICYmICF0aGlzLnJlZnJlc2hJblByb2dyZXNzKSB7XG4gICAgICB0aGlzLnJlZnJlc2hJblByb2dyZXNzID0gdHJ1ZTtcblxuICAgICAgdGhpcy5hdXRoU2VydmljZS5yZWZyZXNoVG9rZW4oKVxuICAgICAgICAuc3Vic2NyaWJlKHtcbiAgICAgICAgICBuZXh0OiAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnJlZnJlc2hJblByb2dyZXNzID0gZmFsc2U7XG4gICAgICAgICAgICB0aGlzLnJlZnJlc2hTdWJqZWN0Lm5leHQodHJ1ZSk7XG4gICAgICAgICAgfSxcbiAgICAgICAgICBlcnJvcjogKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5yZWZyZXNoSW5Qcm9ncmVzcyA9IGZhbHNlO1xuICAgICAgICAgICAgdGhpcy5yZWZyZXNoU3ViamVjdC5uZXh0KGZhbHNlKTtcbiAgICAgICAgICB9LFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAocmVmcmVzaFNob3VsZEhhcHBlbiAmJiB0aGlzLnJlZnJlc2hJblByb2dyZXNzKSB7XG4gICAgICByZXR1cm4gdGhpcy5yZXRyeVJlcXVlc3QocmVxLCByZXMpO1xuICAgIH1cblxuICAgIHJldHVybiB0aHJvd0Vycm9yKCgpID0+IHJlcyk7XG4gIH1cblxuICAvKipcbiAgICogQWRkIGFjY2VzcyB0b2tlbiB0byBoZWFkZXJzIG9yIHRoZSByZXF1ZXN0XG4gICAqL1xuICBwcml2YXRlIGFkZFRva2VuKHJlcTogSHR0cFJlcXVlc3Q8YW55Pik6IE9ic2VydmFibGU8SHR0cFJlcXVlc3Q8YW55Pj4ge1xuICAgIHJldHVybiB0aGlzLmF1dGhTZXJ2aWNlLmdldEFjY2Vzc1Rva2VuKClcbiAgICAgIC5waXBlKFxuICAgICAgICBmaXJzdCgpLFxuICAgICAgICBtYXAoKHRva2VuOiBzdHJpbmcgfCBudWxsKSA9PiB7XG4gICAgICAgICAgaWYgKHRva2VuKSB7XG4gICAgICAgICAgICByZXR1cm4gcmVxLmNsb25lKHtcbiAgICAgICAgICAgICAgc2V0SGVhZGVyczogdGhpcy5hdXRoU2VydmljZS5nZXRIZWFkZXJzPy4odG9rZW4pID8/IHsgQXV0aG9yaXphdGlvbjogYEJlYXJlciAke3Rva2VufWAgfSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiByZXE7XG4gICAgICAgIH0pLFxuICAgICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEZWxheSByZXF1ZXN0LCBieSBzdWJzY3JpYmluZyBvbiByZWZyZXNoIGV2ZW50LCBvbmNlIGl0IGZpbmlzaGVkLCBwcm9jZXNzIGl0XG4gICAqIG90aGVyd2lzZSB0aHJvdyBlcnJvclxuICAgKi9cbiAgcHJpdmF0ZSBkZWxheVJlcXVlc3QocmVxOiBIdHRwUmVxdWVzdDxhbnk+KTogT2JzZXJ2YWJsZTxIdHRwUmVxdWVzdDxhbnk+PiB7XG4gICAgcmV0dXJuIHRoaXMucmVmcmVzaFN1YmplY3QucGlwZShcbiAgICAgIGZpcnN0KCksXG4gICAgICBzd2l0Y2hNYXAoKHN0YXR1czogYm9vbGVhbikgPT5cbiAgICAgICAgc3RhdHVzID8gdGhpcy5hZGRUb2tlbihyZXEpIDogdGhyb3dFcnJvcigoKSA9PiByZXEpXG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXRyeSByZXF1ZXN0LCBieSBzdWJzY3JpYmluZyBvbiByZWZyZXNoIGV2ZW50LCBvbmNlIGl0IGZpbmlzaGVkLCBwcm9jZXNzIGl0XG4gICAqIG90aGVyd2lzZSB0aHJvdyBlcnJvclxuICAgKi9cbiAgcHJpdmF0ZSByZXRyeVJlcXVlc3QoXG4gICAgcmVxOiBIdHRwUmVxdWVzdDxhbnk+LFxuICAgIHJlczogSHR0cEVycm9yUmVzcG9uc2VcbiAgKTogT2JzZXJ2YWJsZTxIdHRwRXZlbnQ8YW55Pj4ge1xuICAgIHJldHVybiB0aGlzLnJlZnJlc2hTdWJqZWN0LnBpcGUoXG4gICAgICBmaXJzdCgpLFxuICAgICAgc3dpdGNoTWFwKChzdGF0dXM6IGJvb2xlYW4pID0+XG4gICAgICAgIHN0YXR1cyA/IHRoaXMuaHR0cC5yZXF1ZXN0KHJlcSkgOiB0aHJvd0Vycm9yKCgpID0+IHJlcyB8fCByZXEpXG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVja3MgaWYgcmVxdWVzdCBtdXN0IGJlIHNraXBwZWQgYnkgaW50ZXJjZXB0b3IuXG4gICAqL1xuICBwcml2YXRlIHNraXBSZXF1ZXN0KHJlcTogSHR0cFJlcXVlc3Q8YW55PiwpIHtcbiAgICByZXR1cm4gdGhpcy5hdXRoU2VydmljZS5za2lwUmVxdWVzdD8uKHJlcSkgfHwgdGhpcy5hdXRoU2VydmljZS52ZXJpZnlSZWZyZXNoVG9rZW4/LihyZXEpO1xuICB9XG59XG4iXX0=